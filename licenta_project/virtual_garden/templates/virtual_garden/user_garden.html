{% load static %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="{% static 'blog/main.css' %}">

  <style>
    /* MODERN CLEAN DESIGN */
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #f0f7da 100%);
      background-attachment: fixed;
    }

    .garden-hero {
      background: linear-gradient(135deg, #4CAF50 0%, #fffec8 100%);
      border-radius: 20px;
      padding: 3rem 2rem;
      margin: 2rem 0;
      text-align: center;
      color: white;
      position: relative;
      overflow: hidden;
    }

    .garden-hero::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="flower-pattern" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23flower-pattern)"/></svg>');
      animation: float 20s ease-in-out infinite;
      pointer-events: none;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(180deg); }
    }

    .garden-title {
      font-size: 2.5rem;
      font-weight: 300;
      margin-bottom: 0.5rem;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      position: relative;
      z-index: 1;
    }

    .garden-subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
      position: relative;
      z-index: 1;
    }

    /* PLANT SECTIONS */
    .plant-section {
      background: rgba(255,255,255,0.95);
      border-radius: 20px;
      padding: 2rem;
      margin: 1rem 0;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(76, 175, 80, 0.1);
      box-shadow: 0 8px 25px rgba(0,0,0,0.08);
    }

    .section-title {
      color: #333;
      font-size: 1.3rem;
      font-weight: 400;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .flower-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 1rem;
      justify-items: center;
    }

    .flower-item {
      background: white;
      border-radius: 15px;
      padding: 1rem;
      text-align: center;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .flower-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.15);
      border-color: rgba(76, 175, 80, 0.3);
    }

    .flower-item.selected {
      border-color: #4CAF50;
      background: rgba(76, 175, 80, 0.05);
      transform: translateY(-3px);
    }

    .flower-image {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 50%;
      border: 3px solid #f0f0f0;
      margin-bottom: 0.8rem;
      transition: all 0.3s ease;
    }

    .flower-item:hover .flower-image {
      border-color: #4CAF50;
    }

    .flower-name {
      font-size: 0.9rem;
      font-weight: 500;
      color: #333;
      margin: 0;
    }

    .flower-locked {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .flower-locked:hover {
      transform: none;
      border-color: transparent;
    }

    .flower-locked .flower-image {
      filter: grayscale(100%);
    }

    /* RESPONSIVE GARDEN CANVAS */
    .garden-area {
      background: rgba(255,255,255,0.95);
      border-radius: 20px;
      padding: 2rem;
      margin: 1rem 0;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(76, 175, 80, 0.1);
      box-shadow: 0 8px 25px rgba(0,0,0,0.08);
    }

    .garden-canvas {
      position: relative;
      width: 100%;
      height: 600px; /* Default desktop height */
      background: url('{% static "virtual_garden/images/garden-background.png" %}');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      border-radius: 15px;
      border: 2px solid rgba(76, 175, 80, 0.2);
      overflow: hidden;
      cursor: crosshair;
      box-shadow: inset 0 4px 12px rgba(0,0,0,0.05);
      transition: height 0.3s ease; /* Smooth height transition */
    }

    .garden-canvas::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        radial-gradient(circle at 20% 30%, rgba(34,139,34,0.1) 2px, transparent 2px),
        radial-gradient(circle at 70% 80%, rgba(34,139,34,0.08) 1px, transparent 1px),
        radial-gradient(circle at 40% 70%, rgba(34,139,34,0.06) 3px, transparent 3px);
      background-size: 40px 40px, 60px 60px, 80px 80px;
      pointer-events: none;
    }

    .garden-canvas.can-plant {
      border-color: #4CAF50;
      box-shadow: inset 0 4px 12px rgba(76, 175, 80, 0.1), 0 0 20px rgba(76, 175, 80, 0.3);
    }

    .planted-flower-free {
      position: absolute;
      width: 80px; /* Default desktop size */
      height: 80px;
      object-fit: cover;
      border-radius: 50%;
      border: 3px solid transparent;
      cursor: grab;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 10;
      animation: plant-appear 0.5s ease-out;
      touch-action: none;
    }
    
    .planted-flower-free:hover {
      transform: scale(1.1);
      border-color: #FFD700;
      box-shadow: 0 8px 20px rgba(255,215,0,0.4);
      z-index: 20;
    }
    
    .planted-flower-free:active,
    .planted-flower-free.dragging {
      cursor: grabbing;
      transform: scale(1.2) rotate(5deg);
      z-index: 30;
      border-color: #ff6b6b;
      box-shadow: 0 12px 30px rgba(255,107,107,0.4);
    }

    @keyframes plant-appear {
      0% { 
        transform: scale(0) rotate(180deg); 
        opacity: 0; 
      }
      70% { 
        transform: scale(1.2) rotate(-10deg); 
        opacity: 0.8; 
      }
      100% { 
        transform: scale(1) rotate(0deg); 
        opacity: 1; 
      }
    }

    .garden-guide {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255,255,255,0.9);
      padding: 0.8rem 1.2rem;
      border-radius: 10px;
      font-size: 0.85rem;
      color: #2e7d32;
      border: 1px solid rgba(76, 175, 80, 0.3);
      z-index: 5;
    }

    .garden-stats {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.9);
      padding: 0.8rem 1.2rem;
      border-radius: 10px;
      font-size: 0.85rem;
      color: #2e7d32;
      border: 1px solid rgba(76, 175, 80, 0.3);
      z-index: 5;
    }

    .remove-zone {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,107,107,0.9);
      color: white;
      padding: 1rem 2rem;
      border-radius: 25px;
      font-weight: 500;
      border: 2px dashed rgba(255,255,255,0.5);
      opacity: 0;
      transition: all 0.3s ease;
      pointer-events: none;
      z-index: 15;
    }

    .remove-zone.active {
      opacity: 1;
      pointer-events: all;
    }

    .remove-zone:hover {
      background: rgba(220,53,69,0.9);
      transform: translateX(-50%) scale(1.05);
    }

    /* CONTROLS */
    .garden-controls {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin: 2rem 0;
    }

    .btn-garden {
      background: linear-gradient(135deg, #4CAF50, #66BB6A);
      border: none;
      border-radius: 25px;
      padding: 12px 25px;
      color: white;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }

    .btn-garden:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
      background: linear-gradient(135deg, #45a049, #5db75d);
    }

    .btn-garden.btn-secondary {
      background: linear-gradient(135deg, #6c757d, #868e96);
      box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
    }

    .btn-garden.btn-secondary:hover {
      background: linear-gradient(135deg, #5a6268, #6c757d);
      box-shadow: 0 8px 25px rgba(108, 117, 125, 0.4);
    }

    /* INSTRUCTIONS */
    .instructions {
      background: rgba(76, 175, 80, 0.1);
      border: 1px solid rgba(76, 175, 80, 0.2);
      border-radius: 15px;
      padding: 1.5rem;
      margin: 1rem 0;
      text-align: center;
    }

    .instructions p {
      margin: 0;
      color: #2e7d32;
      font-weight: 500;
    }

    /* MOBILE RESPONSIVE - ADAPT SAME CANVAS */
    @media (max-width: 768px) {
      .garden-hero {
        padding: 2rem 1rem;
        margin: 1rem 0;
      }
      
      .garden-title {
        font-size: 2rem;
      }
      
      .flower-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .plant-section,
      .garden-area {
        padding: 1.5rem;
        margin: 0.5rem 0;
      }

      /* Adjust canvas height for mobile */
      .garden-canvas {
        height: 350px; /* Smaller height on mobile */
        border-radius: 10px;
      }

      .garden-canvas::before {
        background-size: 30px 30px, 50px 50px, 70px 70px;
      }

      /* Adjust flower size for mobile */
      .planted-flower-free {
        width: 60px;
        height: 60px;
      }

      .garden-guide {
        padding: 0.6rem 0.8rem;
        font-size: 0.75rem;
        border-radius: 8px;
      }

      .garden-stats {
        padding: 0.6rem 0.8rem;
        font-size: 0.75rem;
        border-radius: 8px;
      }

      .remove-zone {
        padding: 0.8rem 1.5rem;
        font-size: 0.85rem;
        border-radius: 20px;
      }

      .garden-controls {
        flex-direction: column;
        gap: 0.8rem;
        margin: 1.5rem 0;
      }

      .btn-garden {
        width: 100%;
        padding: 12px 20px;
      }
    }

    /* EXTRA SMALL DEVICES */
    @media (max-width: 480px) {
      .garden-canvas {
        height: 280px;
      }

      .planted-flower-free {
        width: 50px;
        height: 50px;
      }

      .flower-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .garden-guide,
      .garden-stats {
        padding: 0.5rem 0.6rem;
        font-size: 0.7rem;
      }
    }
  </style>

  <title>{{ garden_owner.username }}'s Garden - Plant Garden</title>
</head>

<body>
  <header class="site-header">
    <nav class="navbar navbar-expand-md navbar-dark bg-steel fixed-top">
      <div class="container">
        <a class="navbar-brand navbar-brand-enhanced mr-4" href="{% url 'blog-classifier' %}">Florli</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarToggle">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarToggle">
          <div class="navbar-nav mr-auto">
            <a class="nav-item nav-link" href="{% url 'blog-classifier' %}">Home</a>
            <a class="nav-item nav-link" href="{% url 'blog-home' %}">Blog</a>
            <a class="nav-item nav-link" href="{% url 'activity-feed' %}">Activity</a>
            <a class="nav-item nav-link" href="{% url 'blog-about' %}">About</a>
          </div>
          <div class="navbar-nav">
            <a class="nav-item nav-link" href="{% url 'virtual-garden' %}">Flowers</a>
            {% if user.is_authenticated %}
              <a class="nav-item nav-link" href="{% url 'user-garden' user.username %}">My Garden</a>
              <a class="nav-item nav-link" href="{% url 'post-create' %}">New Post</a>
              <a class="nav-item nav-link" href="{% url 'profile' %}">Profile</a>
              <a class="nav-item nav-link" href="{% url 'logout' %}">Logout</a>
            {% else %}
              <a class="nav-item nav-link" href="{% url 'login' %}">Login</a>
              <a class="nav-item nav-link" href="{% url 'register' %}">Register</a>
            {% endif %}
          </div>
        </div>
      </div>
    </nav>
  </header>

  <main role="main" class="container" style="margin-top: 80px;">
    <div class="garden-hero">
      <h1 class="garden-title">{{ garden_owner.username }}'s Garden</h1>
      <p class="garden-subtitle">Design your perfect botanical space</p>
    </div>

    <div class="instructions">
      <p>Select a plant from your collection and click on an empty pot to plant it. Double-click planted flowers to remove them.</p>
    </div>

    <div class="row">
      <div class="col-md-4">
        <div class="plant-section">
          <h3 class="section-title">Available Plants</h3>
          <div class="flower-grid" id="unlocked-flowers">
            {% for gf in garden_flowers %}
              {% if gf.available_for_planting %}
                <div class="flower-item flower-selectable" 
                     data-flower-id="{{ gf.flower.id }}" 
                     data-icon-path="{% get_media_prefix %}{{ gf.flower.icon_path }}"
                     data-flower-name="{{ gf.flower.name }}">
                  <img src="{% get_media_prefix %}{{ gf.flower.icon_path }}" 
                       class="flower-image" 
                       alt="{{ gf.flower.name }}">
                  <p class="flower-name">{{ gf.flower.name }}</p>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>

        <div class="plant-section">
          <h3 class="section-title">Locked Plants</h3>
          <div class="flower-grid">
            {% for gf in garden_flowers %}
              {% if not gf.unlocked %}
                <div class="flower-item flower-locked">
                  <img src="{% get_media_prefix %}{{ gf.flower.icon_path }}" 
                       class="flower-image" 
                       alt="{{ gf.flower.name }}">
                  <p class="flower-name">{{ gf.flower.name }}</p>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="col-md-8">
        <div class="garden-area">
          <h3 class="section-title">Free Garden Canvas</h3>
          
          <form method="POST" id="garden-form">
            {% csrf_token %}
            
            <!-- SINGLE RESPONSIVE CANVAS -->
            <div class="garden-canvas" id="gardenCanvas">
              <div class="garden-guide">
                Click to plant selected flowers anywhere!
              </div>
              <div class="garden-stats">
                <span id="plantedCount">0</span> / 18 planted
              </div>
              <div class="remove-zone" id="removeZone">
                Drop here to remove
              </div>
            </div>
              
            {% for slot in slots %}
              <input type="hidden" name="flower_{{ slot.slot_index }}" id="slot-{{ slot.slot_index }}" value="{% if slot.flower %}{{ slot.flower.id }}{% endif %}">
              <input type="hidden" name="pos_x_{{ slot.slot_index }}" id="pos-x-{{ slot.slot_index }}" value="{{ slot.pos_x|default:'' }}">
              <input type="hidden" name="pos_y_{{ slot.slot_index }}" id="pos-y-{{ slot.slot_index }}" value="{{ slot.pos_y|default:'' }}">
            {% endfor %}
            
            {% if user == garden_owner %}
              <div class="garden-controls">
                <button type="submit" class="btn-garden">
                  Save Garden
                </button>
                <button type="button" class="btn-garden btn-secondary" id="clearGarden">
                  Clear All
                </button>
              </div>
            {% endif %}
          </form>
        </div>
      </div>
    </div>
  </main>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    let selectedFlower = null;
    let plantedFlowers = [];
    let draggedFlower = null;
    let nextSlotIndex = 0;

    const gardenCanvas = document.getElementById('gardenCanvas');
    const removeZone = document.getElementById('removeZone');
    const plantedCountEl = document.getElementById('plantedCount');

    function getCanvasDimensions() {
      const screenWidth = window.innerWidth;
      let canvasHeight, flowerSize;
      
      if (screenWidth <= 480) {
        canvasHeight = 280;
        flowerSize = 50;
      } else if (screenWidth <= 768) {
        canvasHeight = 350;
        flowerSize = 60;
      } else {
        canvasHeight = 600;
        flowerSize = 80;
      }
      
      return {
        width: gardenCanvas.offsetWidth,
        height: canvasHeight,
        flowerSize: flowerSize
      };
    }

    function percentageToPixels(xPercent, yPercent) {
      const dimensions = getCanvasDimensions();
      const maxX = dimensions.width - dimensions.flowerSize;
      const maxY = dimensions.height - dimensions.flowerSize;
      
      const x = Math.max(0, Math.min((xPercent / 100) * maxX, maxX));
      const y = Math.max(0, Math.min((yPercent / 100) * maxY, maxY));
      
      return { x, y };
    }

    function pixelsToPercentage(x, y) {
      const dimensions = getCanvasDimensions();
      const maxX = dimensions.width - dimensions.flowerSize;
      const maxY = dimensions.height - dimensions.flowerSize;
      
      const xPercent = maxX > 0 ? (x / maxX) * 100 : 0;
      const yPercent = maxY > 0 ? (y / maxY) * 100 : 0;
      
      return { 
        xPercent: Math.max(0, Math.min(xPercent, 100)), 
        yPercent: Math.max(0, Math.min(yPercent, 100)) 
      };
    }

    function updateFlowerPositionInputs(flowerEl, x, y) {
      const slotIndex = flowerEl.dataset.slotIndex;
      const slotInput = document.getElementById('slot-' + slotIndex);
      const posXInput = document.getElementById('pos-x-' + slotIndex);
      const posYInput = document.getElementById('pos-y-' + slotIndex);
      
      const percentages = pixelsToPercentage(x, y);
      
      if (slotInput) slotInput.value = flowerEl.dataset.flowerId;
      if (posXInput) posXInput.value = percentages.xPercent.toFixed(2);
      if (posYInput) posYInput.value = percentages.yPercent.toFixed(2);
      
      console.log(`Floare ${flowerEl.dataset.flowerName}: px(${x}, ${y}) -> %(${percentages.xPercent.toFixed(2)}, ${percentages.yPercent.toFixed(2)})`);
    }

    function loadExistingFlowers() {
      {% for slot in slots %}
        {% if slot.flower %}
          var posX_{{ slot.slot_index }} = {{ slot.pos_x|default:"null" }};
          var posY_{{ slot.slot_index }} = {{ slot.pos_y|default:"null" }};
          
          if (posX_{{ slot.slot_index }} !== null && posY_{{ slot.slot_index }} !== null) {
            var finalX, finalY;
            
            if (posX_{{ slot.slot_index }} <= 100 && posY_{{ slot.slot_index }} <= 100) {
              const pos = percentageToPixels(posX_{{ slot.slot_index }}, posY_{{ slot.slot_index }});
              finalX = pos.x;
              finalY = pos.y;
              console.log(`Încărcare din procente: ${posX_{{ slot.slot_index }}}%, ${posY_{{ slot.slot_index }}}% -> ${finalX}px, ${finalY}px`);
            } else {
              const dimensions = getCanvasDimensions();
              
              const originalMaxX = 800 - 80;
              const originalMaxY = 600 - 80;
              
              const xPercent = (posX_{{ slot.slot_index }} / originalMaxX) * 100;
              const yPercent = (posY_{{ slot.slot_index }} / originalMaxY) * 100;
              
              const pos = percentageToPixels(xPercent, yPercent);
              finalX = pos.x;
              finalY = pos.y;
              console.log(`Migrare din pixeli: ${posX_{{ slot.slot_index }}}px, ${posY_{{ slot.slot_index }}}px -> ${xPercent.toFixed(2)}%, ${yPercent.toFixed(2)}% -> ${finalX}px, ${finalY}px`);
            }
            
            createPlantedFlower({
              id: '{{ slot.flower.id }}',
              icon: '{% get_media_prefix %}{{ slot.flower.icon_path }}',
              name: '{{ slot.flower.name }}'
            }, finalX, finalY, {{ slot.slot_index }});
          }
        {% endif %}
        
        if ({{ slot.slot_index }} >= nextSlotIndex) {
          nextSlotIndex = {{ slot.slot_index }} + 1;
        }
      {% endfor %}
      
      updatePlantedCount();
    }
    document.querySelectorAll('.flower-selectable').forEach(plant => {
      plant.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('Flower clicked:', this.dataset.flowerName);
        
        document.querySelectorAll('.flower-selectable').forEach(p => p.classList.remove('selected'));
        
        this.classList.add('selected');
        selectedFlower = {
          id: this.dataset.flowerId,
          icon: this.dataset.iconPath,
          name: this.dataset.flowerName,
          element: this
        };

        console.log('Selected flower:', selectedFlower);
        gardenCanvas.classList.add('can-plant');
      });
    });
    function getEventCoordinates(e) {
      if (e.touches && e.touches.length > 0) {
        return {
          clientX: e.touches[0].clientX,
          clientY: e.touches[0].clientY
        };
      } else {
        return {
          clientX: e.clientX,
          clientY: e.clientY
        };
      }
    }

    function handleCanvasInteraction(e) {
      e.preventDefault();
      console.log('Canvas clicked/touched, selectedFlower:', selectedFlower);
      
      if (!selectedFlower) {
        console.log('No flower selected');
        return;
      }
      
      if (e.target.classList.contains('planted-flower-free') ||
          e.target.classList.contains('garden-guide') ||
          e.target.classList.contains('garden-stats') ||
          e.target.classList.contains('remove-zone')) {
        console.log('Clicked on UI element, ignoring');
        return;
      }

      console.log('Planting flower...');

      const coords = getEventCoordinates(e);
      const rect = gardenCanvas.getBoundingClientRect();
      const dimensions = getCanvasDimensions();
      
      const x = coords.clientX - rect.left - (dimensions.flowerSize / 2);
      const y = coords.clientY - rect.top - (dimensions.flowerSize / 2);

      const maxX = dimensions.width - dimensions.flowerSize;
      const maxY = dimensions.height - dimensions.flowerSize;
      const finalX = Math.max(0, Math.min(x, maxX));
      const finalY = Math.max(0, Math.min(y, maxY));

      console.log('Planting at position:', finalX, finalY);

      const slotIndex = getNextAvailableSlot();
      createPlantedFlower(selectedFlower, finalX, finalY, slotIndex);

      selectedFlower.element.remove();

      selectedFlower = null;
      document.querySelectorAll('.flower-selectable').forEach(p => p.classList.remove('selected'));
      gardenCanvas.classList.remove('can-plant');

      updatePlantedCount();
    }

    gardenCanvas.addEventListener('click', handleCanvasInteraction);
    gardenCanvas.addEventListener('touchstart', handleCanvasInteraction);

    function createPlantedFlower(flowerData, x, y, slotIndex) {
      console.log('Creating planted flower:', flowerData.name, 'at slot:', slotIndex);
      
      const flowerEl = document.createElement('img');
      flowerEl.src = flowerData.icon;
      flowerEl.className = 'planted-flower-free';
      flowerEl.alt = flowerData.name;
      flowerEl.title = flowerData.name;
      flowerEl.style.left = x + 'px';
      flowerEl.style.top = y + 'px';
      flowerEl.dataset.flowerId = flowerData.id;
      flowerEl.dataset.slotIndex = slotIndex;
      flowerEl.dataset.flowerName = flowerData.name;

      makeDraggable(flowerEl);

      gardenCanvas.appendChild(flowerEl);

      updateFlowerPositionInputs(flowerEl, x, y);

      plantedFlowers.push({
        element: flowerEl,
        flowerId: flowerData.id,
        slotIndex: slotIndex
      });
      
      console.log('Flower created successfully');
    }

    function makeDraggable(element) {
      let isDragging = false;
      let startX, startY, startLeft, startTop;
      const isTouchDevice = 'ontouchstart' in window;

      if (isTouchDevice) {
        element.addEventListener('touchstart', startDrag, { passive: false });
        document.addEventListener('touchmove', drag, { passive: false });
        document.addEventListener('touchend', endDrag, { passive: false });
        
        let touchTime = 0;
        element.addEventListener('touchstart', function(e) {
          if (isDragging) return;
          
          if (touchTime === 0) {
            touchTime = new Date().getTime();
          } else {
            if (((new Date().getTime()) - touchTime) < 300) {
              e.preventDefault();
              removeFlower(element);
              touchTime = 0;
            } else {
              touchTime = new Date().getTime();
            }
          }
        });
      }
      
      element.addEventListener('mousedown', startDrag);
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', endDrag);
      element.addEventListener('dblclick', function() {
        removeFlower(element);
      });

      function startDrag(e) {
        e.preventDefault();
        isDragging = true;
        draggedFlower = element;
        element.classList.add('dragging');
        
        const coords = getEventCoordinates(e);
        startX = coords.clientX;
        startY = coords.clientY;
        startLeft = parseInt(element.style.left) || 0;
        startTop = parseInt(element.style.top) || 0;

        removeZone.classList.add('active');
      }

      function drag(e) {
        if (!isDragging || draggedFlower !== element) return;
        e.preventDefault();

        const coords = getEventCoordinates(e);
        const dx = coords.clientX - startX;
        const dy = coords.clientY - startY;
        
        const newLeft = startLeft + dx;
        const newTop = startTop + dy;

        const dimensions = getCanvasDimensions();
        const maxX = dimensions.width - dimensions.flowerSize;
        const maxY = dimensions.height - dimensions.flowerSize;
        
        const finalX = Math.max(0, Math.min(newLeft, maxX));
        const finalY = Math.max(0, Math.min(newTop, maxY));
        
        element.style.left = finalX + 'px';
        element.style.top = finalY + 'px';
      }

      function endDrag(e) {
        if (!isDragging || draggedFlower !== element) return;
        e.preventDefault();

        isDragging = false;
        element.classList.remove('dragging');
        removeZone.classList.remove('active');

        const coords = getEventCoordinates(e);
        const removeRect = removeZone.getBoundingClientRect();
        
        if (coords.clientX >= removeRect.left && 
            coords.clientX <= removeRect.right && 
            coords.clientY >= removeRect.top && 
            coords.clientY <= removeRect.bottom) {
          
          removeFlower(element);
        } else {
          const finalX = parseInt(element.style.left);
          const finalY = parseInt(element.style.top);
          updateFlowerPositionInputs(element, finalX, finalY);
        }

        draggedFlower = null;
      }
    }

    function removeFlower(flowerElement) {
      console.log('Removing flower');
      
      const slotIndex = flowerElement.dataset.slotIndex;
      const flowerId = flowerElement.dataset.flowerId;
      const flowerName = flowerElement.dataset.flowerName || flowerElement.alt;
      const flowerIcon = flowerElement.src;

      const existingFlower = document.querySelector(`[data-flower-id="${flowerId}"].flower-selectable`);
      if (!existingFlower) {
        const unlockedContainer = document.getElementById('unlocked-flowers');
        if (unlockedContainer) {
          const flowerItem = document.createElement('div');
          flowerItem.className = 'flower-item flower-selectable';
          flowerItem.dataset.flowerId = flowerId;
          flowerItem.dataset.iconPath = flowerIcon;
          flowerItem.dataset.flowerName = flowerName;
          flowerItem.style.display = 'block';

          const img = document.createElement('img');
          img.src = flowerIcon;
          img.className = 'flower-image';
          img.alt = flowerName;

          const nameP = document.createElement('p');
          nameP.className = 'flower-name';
          nameP.textContent = flowerName;

          flowerItem.appendChild(img);
          flowerItem.appendChild(nameP);

          flowerItem.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('.flower-selectable').forEach(p => p.classList.remove('selected'));
            
            this.classList.add('selected');
            selectedFlower = {
              id: this.dataset.flowerId,
              icon: this.dataset.iconPath,
              name: this.dataset.flowerName,
              element: this
            };

            gardenCanvas.classList.add('can-plant');
          });

          unlockedContainer.appendChild(flowerItem);
          console.log('Recreated flower in selector:', flowerName);
        }
      } else {
        console.log('Flower already exists in selector, just showing it');
        existingFlower.style.display = 'block';
      }

      flowerElement.remove();

      const slotInput = document.getElementById('slot-' + slotIndex);
      const posXInput = document.getElementById('pos-x-' + slotIndex);
      const posYInput = document.getElementById('pos-y-' + slotIndex);
      
      if (slotInput) slotInput.value = '';
      if (posXInput) posXInput.value = '';
      if (posYInput) posYInput.value = '';

      plantedFlowers = plantedFlowers.filter(f => f.slotIndex != slotIndex);
      
      updatePlantedCount();
      console.log('Flower removed successfully');
    }

    function handleResize() {
      const plantedFlowerElements = document.querySelectorAll('.planted-flower-free');
      
      plantedFlowerElements.forEach(flower => {
        const slotIndex = flower.dataset.slotIndex;
        const posXInput = document.getElementById('pos-x-' + slotIndex);
        const posYInput = document.getElementById('pos-y-' + slotIndex);
        
        if (posXInput && posYInput && posXInput.value && posYInput.value) {
          const xPercent = parseFloat(posXInput.value);
          const yPercent = parseFloat(posYInput.value);
          
          const newPos = percentageToPixels(xPercent, yPercent);
          
          flower.style.left = newPos.x + 'px';
          flower.style.top = newPos.y + 'px';
        }
      });
      
      console.log(`Redimensionat: ${plantedFlowerElements.length} flori repoziționare`);
    }

    function getNextAvailableSlot() {
      for (let i = nextSlotIndex; i < 18; i++) {
        const input = document.getElementById('slot-' + i);
        if (input && input.value === '') {
          return i;
        }
      }
      
      for (let i = 0; i < nextSlotIndex; i++) {
        const input = document.getElementById('slot-' + i);
        if (input && input.value === '') {
          return i;
        }
      }
      
      return 0;
    }

    function updatePlantedCount() {
      plantedCountEl.textContent = plantedFlowers.length;
    }

    document.getElementById('garden-form').addEventListener('submit', function(e) {
      const plantedFlowerElements = document.querySelectorAll('.planted-flower-free');
      plantedFlowerElements.forEach(flower => {
        const currentX = parseInt(flower.style.left);
        const currentY = parseInt(flower.style.top);
        updateFlowerPositionInputs(flower, currentX, currentY);
      });
    });

    document.getElementById('clearGarden')?.addEventListener('click', function() {
      if (confirm('Ești sigur că vrei să ștergi întreaga grădină?')) {
        const plantedFlowerElements = document.querySelectorAll('.planted-flower-free');
        plantedFlowerElements.forEach(flower => {
          removeFlower(flower);
        });

        if (selectedFlower) {
          selectedFlower.element.classList.remove('selected');
          selectedFlower = null;
          gardenCanvas.classList.remove('can-plant');
        }
      }
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        if (selectedFlower) {
          selectedFlower.element.classList.remove('selected');
          selectedFlower = null;
          gardenCanvas.classList.remove('can-plant');
        }
      }
    });

    let resizeTimeout;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(handleResize, 150);
    });
    loadExistingFlowers();      
    console.log('Garden virtual cu poziționare responsivă inițializat');
    console.log('Found flower elements:', document.querySelectorAll('.flower-selectable').length);
    console.log('Garden canvas element:', gardenCanvas);
  });
</script>
</body>
</html>